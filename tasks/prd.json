{
  "name": "BeerBot Mobile App MVP V1.0",
  "description": "Complete customer-facing mobile app (iOS + Android) for BeerBot self-service beer dispensing system. Includes backend API with Stripe payments, age verification, GPS venue detection, QR-based order redemption, and real-time inventory awareness. Built with React Native + Expo, Supabase backend, and TypeScript.",
  "branchName": "ralph/beerbot-mobile-app",
  "userStories": [
    {
      "id": "US-001",
      "title": "Initialize Expo project with TypeScript and core dependencies",
      "description": "As a developer, I want the Expo project scaffolded with all core dependencies so that development can begin on a solid foundation.",
      "acceptanceCriteria": [
        "Create Expo project with SDK 52+ using TypeScript strict template",
        "Install and configure NativeWind (Tailwind CSS for RN) with design tokens",
        "Install and configure Expo Router (file-based navigation) with auth layout groups",
        "Install Zustand for global state management",
        "Install TanStack Query for server state caching",
        "Install react-native-reanimated and lottie-react-native for animations",
        "Install expo-location, expo-secure-store, expo-notifications",
        "Install react-native-qrcode-svg for QR generation",
        "Configure app.json with BeerBot branding (name, slug, scheme for deep links)",
        "Create folder structure: app/(auth)/, app/(main)/, lib/, components/, hooks/, types/",
        "Verify the app compiles and launches on iOS simulator and Android emulator",
        "npx expo lint passes",
        "npx tsc --noEmit passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "dependsOn": [],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-002",
      "title": "Create Supabase database schema and migrations",
      "description": "As a developer, I want all database tables created with proper types, constraints, and indexes so that the backend has a solid data foundation.",
      "acceptanceCriteria": [
        "Create 'users' table: id (uuid PK), email (unique), phone, full_name, age_verified (bool default false), age_verification_ref, age_verified_at, stripe_customer_id, created_at, updated_at",
        "Create 'venues' table: id (uuid PK), name, address, latitude (decimal), longitude (decimal), is_active (bool default true), mobile_ordering_enabled (bool default true), created_at",
        "Create 'beers' table: id (uuid PK), name, style, abv (decimal), description, image_url, created_at",
        "Create 'taps' table: id (uuid PK), venue_id (FK), tap_number (int), beer_id (FK nullable), status (enum: active/inactive/maintenance), oz_remaining (decimal), low_threshold_oz (decimal default 120), temperature_f (decimal nullable), temp_ok (bool default true), temp_threshold_f (decimal default 38), created_at, updated_at",
        "Create 'tap_pricing' table: id (uuid PK), tap_id (FK), price_12oz (decimal), pour_size_oz (decimal default 12), currency (text default 'usd'), created_at",
        "Create 'orders' table: id (uuid PK), user_id (FK), venue_id (FK), tap_id (FK), beer_id (FK), quantity (int), pour_size_oz (decimal), unit_price (decimal), total_amount (decimal), currency, status (enum: pending_payment/paid/ready_to_redeem/redeemed/pouring/completed/expired/cancelled/refunded), qr_code_token (unique nullable), qr_expires_at, stripe_payment_intent_id, paid_at, redeemed_at, completed_at, expires_at, created_at, updated_at",
        "Create 'order_events' table: id (uuid PK), order_id (FK), event_type (text), metadata (jsonb nullable), created_at",
        "Create 'admin_pour_logs' table: id (uuid PK), tap_id (FK), admin_user_id, pour_size_oz (decimal), master_code_used (bool), reason, created_at",
        "Add indexes on: orders.user_id, orders.venue_id, orders.status, taps.venue_id, orders.qr_code_token",
        "All migrations tracked in supabase/migrations/ directory",
        "Seed data: at least 1 venue, 3 beers, 3 taps with pricing for development",
        "npx tsc --noEmit passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Run via Supabase CLI: supabase db push or supabase migration up",
      "dependsOn": [],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-003",
      "title": "Configure Supabase Auth and Row Level Security policies",
      "description": "As a developer, I want auth and RLS configured so that the app has secure, role-appropriate data access from day one.",
      "acceptanceCriteria": [
        "Enable Supabase Auth with email/password provider",
        "Create trigger to auto-create user profile row in 'users' table on auth signup",
        "Enable RLS on ALL tables",
        "RLS policy: users can SELECT/UPDATE only their own row in 'users' table",
        "RLS policy: venues, beers, taps, tap_pricing are publicly readable (SELECT for anon and authenticated)",
        "RLS policy: orders are SELECT/INSERT only by the owning user (user_id = auth.uid())",
        "RLS policy: order_events are SELECT only by the order owner (via join to orders)",
        "RLS policy: admin_pour_logs require service_role key (not accessible by app users)",
        "Configure Supabase client in lib/supabase.ts with environment variables",
        "Test: authenticated user can read venues, create order, cannot read other users' orders",
        "npx tsc --noEmit passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-002"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-004",
      "title": "Build Venues and Taps API with proximity sorting",
      "description": "As a developer, I want API queries for venues and taps so that the mobile app can fetch location-aware beer data.",
      "acceptanceCriteria": [
        "Create lib/api/venues.ts with typed query functions using Supabase client",
        "GET venues: fetch all active venues, support optional lat/lng params for proximity sorting",
        "Proximity sorting uses PostGIS earth_distance or manual Haversine calculation in SQL function",
        "GET venue taps: fetch active taps for a venue with joined beer name, style, price, availability",
        "Compute availability_status per tap: 'available' (oz_remaining > threshold), 'low' (oz_remaining <= threshold and > 0), 'out' (oz_remaining <= 0)",
        "Include temp_ok boolean and temperature_f in tap response",
        "Create Supabase realtime subscription helper for taps table (live inventory/temp updates)",
        "Create TypeScript types in types/api.ts: Venue, Tap, Beer, TapWithBeer",
        "Response times < 200ms verified with seed data",
        "npx expo lint passes",
        "npx tsc --noEmit passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-003"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-005",
      "title": "Build Orders API with atomic inventory validation",
      "description": "As a developer, I want order creation and retrieval endpoints so that the mobile app can manage the full order lifecycle.",
      "acceptanceCriteria": [
        "Create Supabase Edge Function: create-order",
        "Validates: user age_verified = true, tap is active, venue is active, mobile_ordering_enabled = true",
        "Validates: oz_remaining > low_threshold_oz (blocks ordering when low)",
        "Validates: temp_ok = true (blocks ordering when beer not at temp)",
        "Order creation is ATOMIC: validate inventory + create order + decrement oz_remaining in a single database transaction (use Supabase RPC/function)",
        "Sets order status to 'pending_payment', calculates total_amount from tap_pricing",
        "Sets expires_at to current time + 15 minutes (configurable)",
        "Create lib/api/orders.ts with typed functions: createOrder, getOrder, getOrderHistory",
        "getOrderHistory returns paginated results (limit/offset), newest first",
        "Create TypeScript types: Order, OrderStatus, CreateOrderRequest",
        "Logs 'created' event in order_events",
        "npx expo lint passes",
        "npx tsc --noEmit passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-004"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-006",
      "title": "Build QR Token generation with JWT signing",
      "description": "As a developer, I want cryptographically signed QR tokens so that order redemption is secure and tamper-proof.",
      "acceptanceCriteria": [
        "Create Supabase Edge Function or database function: generate-qr-token",
        "Token is a JWT signed with a server-side secret (stored in Supabase secrets)",
        "JWT payload contains: order_id, tap_id, venue_id, user_id, exp (expiration timestamp)",
        "Token expiration matches order.expires_at",
        "Token is stored in orders.qr_code_token column",
        "Create validation function: verify-qr-token that decodes and validates the JWT",
        "Validation checks: signature valid, not expired, order exists, order not already redeemed",
        "Token is single-use: once validated for redemption, order status changes prevent reuse",
        "Create lib/utils/qr.ts with helper to generate QR data string from token for client-side rendering",
        "npx expo lint passes",
        "npx tsc --noEmit passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-005"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-007",
      "title": "Build Stripe Payment Intent Edge Function",
      "description": "As a developer, I want Stripe payment processing so that users can pay securely with Apple Pay, Google Pay, or card.",
      "acceptanceCriteria": [
        "Install @stripe/stripe-react-native in the Expo project",
        "Create Supabase Edge Function: create-payment-intent",
        "Accepts order_id, creates Stripe PaymentIntent with amount from order.total_amount",
        "PaymentIntent metadata includes: order_id, user_id, venue_id, tap_id",
        "Uses idempotency key (order_id) to prevent duplicate charges",
        "Creates or retrieves Stripe Customer for the user (links to users.stripe_customer_id)",
        "Returns client_secret and ephemeral_key to the mobile app",
        "Configure Stripe publishable key in app environment variables",
        "Create lib/api/payments.ts with typed functions: createPaymentIntent, initializeStripe",
        "Apple Pay and Google Pay merchant configuration documented in README",
        "npx expo lint passes",
        "npx tsc --noEmit passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Stripe secret key stored in Supabase Edge Function secrets",
      "dependsOn": [
        "US-005"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-008",
      "title": "Build Stripe Webhook handler for payment events",
      "description": "As a developer, I want Stripe webhooks handled so that order status updates automatically on payment success or failure.",
      "acceptanceCriteria": [
        "Create Supabase Edge Function: stripe-webhook",
        "Verify Stripe webhook signature using webhook secret",
        "Handle payment_intent.succeeded: update order status to 'paid' then 'ready_to_redeem', trigger QR token generation (call US-006 function)",
        "Handle payment_intent.payment_failed: update order status to 'cancelled', restore oz_remaining",
        "Handle charge.refunded: update order status to 'refunded'",
        "Log all webhook events in order_events table with event metadata",
        "Idempotent handling: if webhook received twice for same event, skip duplicate processing",
        "Return 200 OK to Stripe on successful processing, 500 on error (Stripe will retry)",
        "npx expo lint passes",
        "npx tsc --noEmit passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-006",
        "US-007"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-009",
      "title": "Build Age Verification integration with Veriff",
      "description": "As a developer, I want third-party age verification so that users can prove they are 21+ before purchasing.",
      "acceptanceCriteria": [
        "Install @veriff/react-native-sdk (or equivalent provider SDK)",
        "Create Supabase Edge Function: create-verification-session that calls Veriff API to create a session",
        "Edge Function returns session URL/token to the mobile app",
        "Create Supabase Edge Function: verification-webhook to receive Veriff callback",
        "On verification approved: update users.age_verified = true, store age_verification_ref (Veriff session ID), age_verified_at timestamp",
        "On verification declined: do not update age_verified, allow retry",
        "Do NOT store ID images or personal data -- only status, timestamp, and reference ID",
        "Rate limit: max 5 verification attempts per user per day (enforced in Edge Function)",
        "Create lib/api/verification.ts with typed functions: createVerificationSession, checkVerificationStatus",
        "npx expo lint passes",
        "npx tsc --noEmit passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Veriff API keys stored in Supabase secrets. Can swap to Jumio if client prefers.",
      "dependsOn": [
        "US-003"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-010",
      "title": "Build Order Expiration and Auto-Refund system",
      "description": "As a developer, I want orders to automatically expire and refund if not redeemed within the timeout period.",
      "acceptanceCriteria": [
        "Create Supabase database function: expire_stale_orders that finds orders with status 'ready_to_redeem' and expires_at < now()",
        "Function updates status to 'expired' and logs 'expired' event in order_events",
        "Create Supabase Edge Function: process-expired-orders that calls Stripe Refund API for each expired order",
        "Schedule with pg_cron or Supabase scheduled function to run every minute",
        "Refund uses order.stripe_payment_intent_id to issue full refund",
        "On successful refund: update order status to 'refunded', log 'refunded' event",
        "Restore oz_remaining for the tap (add back the ordered amount)",
        "Handle Stripe refund failures gracefully: log error, mark for manual review",
        "npx expo lint passes",
        "npx tsc --noEmit passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-008"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-011",
      "title": "Build PLC Stub Endpoints matching GIGA contract",
      "description": "As a developer, I want stub endpoints for PLC/Arduino GIGA communication so that the hardware integration phase can plug in without refactoring.",
      "acceptanceCriteria": [
        "Create Supabase Edge Function: pour-start (POST /taps/:id/pour)",
        "Accepts payload: { order_id, tap_id, quantity, pour_size_oz, token }",
        "Validates: JWT token signature, token not expired, order status is 'ready_to_redeem', tap_id matches token",
        "Validates: temp_ok = true for the tap, oz_remaining sufficient",
        "On valid: update order status to 'redeemed' then 'pouring', return pour_command payload",
        "On invalid: return descriptive error codes: WRONG_TAP (include correct tap#), EXPIRED, ALREADY_REDEEMED, TEMP_NOT_READY, INVENTORY_LOW",
        "Create Supabase Edge Function: pour-complete (POST /taps/:id/pour-complete)",
        "Accepts: { order_id, tap_id, actual_oz_poured }, updates order to 'completed'",
        "Both endpoints require service-role authentication (not user auth)",
        "Log all pour events in order_events and admin_pour_logs",
        "npx expo lint passes",
        "npx tsc --noEmit passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "These are stubs -- actual PLC communication flows through local Raspberry Pi backend in future phase",
      "dependsOn": [
        "US-006"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-012",
      "title": "Build Welcome and Onboarding screen",
      "description": "As a new user, I want to see a polished welcome screen so that I understand what BeerBot does and feel confident using it.",
      "acceptanceCriteria": [
        "Create app/(auth)/welcome.tsx with animated splash using Lottie (BeerBot branding placeholder)",
        "Welcome carousel with 2-3 swipeable slides: 'Order your beer', 'Verify your age', 'Scan & Pour'",
        "Carousel uses react-native-reanimated for smooth page transitions and indicators",
        "Swipe gestures work correctly on both iOS and Android",
        "'Get Started' CTA button navigates to registration screen",
        "'I already have an account' link navigates to login screen",
        "All text renders correctly, responsive across iPhone SE to Pro Max sizes",
        "NativeWind styling with BeerBot color palette (dark theme with amber/gold accents)",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 2,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-001"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-013",
      "title": "Build Registration screen",
      "description": "As a new user, I want to create an account with my email so that I can place orders.",
      "acceptanceCriteria": [
        "Create app/(auth)/register.tsx with form: full name, email, password fields",
        "Client-side validation: email format, password min 8 chars, name required",
        "Password strength indicator (weak/medium/strong) using visual bar",
        "Show/hide password toggle on password field",
        "Submit triggers Supabase auth.signUp() with email and password",
        "On success: auto-login via session, navigate to venue selection (app/(main)/venues)",
        "On failure: display specific error messages ('Email already registered', etc.)",
        "Loading state on submit button (disabled + spinner animation)",
        "KeyboardAvoidingView so fields are not hidden behind keyboard",
        "Back navigation to welcome screen",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 3,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-003",
        "US-012"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-014",
      "title": "Build Login screen with biometric auth and session persistence",
      "description": "As a returning user, I want to log in quickly with email/password or biometrics so that I can access my account.",
      "acceptanceCriteria": [
        "Create app/(auth)/login.tsx with email and password fields",
        "Client-side validation before submission",
        "Show/hide password toggle",
        "'Forgot password?' link navigates to forgot-password screen",
        "Submit triggers Supabase auth.signInWithPassword()",
        "On success: navigate to venue selection (or last-used venue from Zustand store)",
        "On failure: display error ('Invalid credentials', 'Account not found')",
        "Biometric login: if user has logged in before, show Face ID/fingerprint option using expo-local-authentication",
        "Session persistence: store Supabase session token in expo-secure-store",
        "Auto-login on app relaunch: check for valid session in app/_layout.tsx, redirect to main if valid",
        "Create auth state management in lib/stores/auth-store.ts using Zustand",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 4,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-013"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-015",
      "title": "Build Forgot Password flow",
      "description": "As a user who forgot my password, I want to reset it via email so that I can regain access.",
      "acceptanceCriteria": [
        "Create app/(auth)/forgot-password.tsx with email input field",
        "Validation: proper email format required",
        "'Send Reset Link' button triggers Supabase auth.resetPasswordForEmail()",
        "Success message: 'Check your email for a reset link'",
        "Create app/(auth)/reset-password.tsx for deep link landing",
        "Configure deep link scheme in app.json to handle Supabase password reset URLs",
        "New password form with confirmation field and validation (min 8 chars, must match)",
        "On success: auto-login and navigate to venue selection",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 5,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-014"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-016",
      "title": "Build Venue Selection screen with GPS detection",
      "description": "As a user, I want the app to detect my location and show nearby venues so I can start ordering immediately.",
      "acceptanceCriteria": [
        "Create app/(main)/venues/index.tsx as the main venue selection screen",
        "Request location permission on screen load using expo-location (graceful denial handling)",
        "If GPS granted: call venues API with lat/lng, display sorted by proximity",
        "Nearest venue shown prominently with distance badge ('0.1 mi away')",
        "If within 200m of a venue: show 'You're here!' indicator with highlight",
        "If GPS denied: show full venue list alphabetically",
        "Search bar at top with real-time filtering by venue name or address",
        "Venue cards show: name, address, distance (if GPS), active tap count, placeholder image",
        "Venues with mobile_ordering_enabled=false show as 'In-person only' (greyed, not tappable)",
        "Pull-to-refresh re-checks location and reloads venues",
        "Empty state: 'No venues found' if search has no matches",
        "Tapping a venue navigates to app/(main)/venues/[id].tsx",
        "Use TanStack Query for data fetching with caching",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 5,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-004",
        "US-014"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-017",
      "title": "Build Beer List screen with availability and temperature badges",
      "description": "As a user at a venue, I want to see all available beers with real-time status so I can choose what to order.",
      "acceptanceCriteria": [
        "Create app/(main)/venues/[id].tsx showing beer list for selected venue",
        "Collapsible venue header: venue name, address, 'Change venue' button; shrinks on scroll",
        "If user GPS is far from venue: subtle warning 'You're not at this venue'",
        "Beer cards show: name, style, price (12oz), availability badge, temperature",
        "Availability badges with color coding: green 'Available', yellow 'Low', red/grey 'Out'",
        "Temperature shown if sensor data exists, 'N/A' if null",
        "If temp_ok=false: show blue 'Cooling down' badge with ice icon, beer not orderable",
        "'Out' beers visually dimmed and not tappable",
        "'Low' beers show warning: 'Limited -- order at the station'",
        "Tapping available beer navigates to beer detail/order screen",
        "Subscribe to Supabase realtime on taps table for live updates",
        "Pull-to-refresh also works",
        "Empty state: 'No beers on tap right now. Check back soon!'",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 6,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-016"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-018",
      "title": "Build Beer Detail and Order Configuration screen",
      "description": "As a user, I want to select quantity and see a price breakdown before proceeding to checkout.",
      "acceptanceCriteria": [
        "Create app/(main)/order/configure.tsx (or modal) with beer detail and order form",
        "Display: beer name, style, ABV, description at top",
        "Beer image (or branded placeholder) shown prominently",
        "Serving size shown as '12 oz' (fixed, not selectable)",
        "Quantity stepper: - / + buttons, range 1-6, default 1 with animated transitions",
        "Live price calculation: unit_price x quantity = total (formatted as $X.XX)",
        "Show assigned tap number: 'Tap #3'",
        "'Continue' CTA button showing total price, navigates to age verification gate",
        "If inventory drops below threshold during viewing: show alert, navigate back to beer list",
        "Temperature and availability shown as live data (realtime subscription)",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 7,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-017"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-019",
      "title": "Build Age Verification Gate screen",
      "description": "As a user proceeding to payment, I want to verify my age if not already verified.",
      "acceptanceCriteria": [
        "Create app/(main)/order/verify-age.tsx",
        "If user.age_verified = true: auto-skip to payment screen immediately",
        "If not verified: show explanation screen with messaging: 'We need to verify you're 21+'",
        "Privacy notice: 'Your ID is processed securely by Veriff and not stored by BeerBot'",
        "'Remember my verification' checkbox (default on)",
        "'Verify My Age' CTA button launches Veriff SDK in-app (not external browser)",
        "SDK handles: ID photo capture, selfie capture, liveness check",
        "Loading state while verification is processing",
        "On success: navigate to payment screen",
        "On failure: show reason ('ID not readable', 'Liveness failed'), allow retry (max 3 attempts)",
        "Handle edge cases: camera permission denied, SDK crash, network timeout",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 8,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-009",
        "US-018"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-020",
      "title": "Build Payment screen with Apple Pay, Google Pay, and card",
      "description": "As a verified user, I want to pay quickly so that checkout is frictionless.",
      "acceptanceCriteria": [
        "Create app/(main)/order/payment.tsx",
        "Order summary at top: beer name, quantity, unit price, total, assigned tap",
        "Initialize Stripe SDK with publishable key on screen mount",
        "Call create-payment-intent Edge Function to get client_secret",
        "Show Apple Pay button on iOS (if available via Stripe)",
        "Show Google Pay button on Android (if available via Stripe)",
        "'Pay with card' fallback option using Stripe CardField or PaymentSheet",
        "If user has saved payment method: show as default with 'Change' option",
        "'Save this card' checkbox (default on) for card payments",
        "Payment amount sourced from PaymentIntent (server-side truth, not client calc)",
        "On payment initiation: show animated processing state (Lottie spinner)",
        "On success (via webhook -> realtime): navigate to QR screen with celebration animation",
        "On failure: show error ('Payment declined'), remain on screen, allow retry",
        "On network error: show 'Checking payment status...' and poll order status",
        "Idempotency: pressing pay twice does NOT create duplicate charges",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 9,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-007",
        "US-019"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-021",
      "title": "Build QR Code Display screen with countdown timer",
      "description": "As a user who paid, I want to see my QR code with clear tap instructions and a redemption countdown.",
      "acceptanceCriteria": [
        "Create app/(main)/order/redeem.tsx",
        "Large QR code rendered center-screen using react-native-qrcode-svg",
        "QR encodes the signed JWT token from order.qr_code_token (not raw order ID)",
        "Below QR: 'Go to Tap #X' in large bold text",
        "Step-by-step instructions: '1. Walk to Tap #X  2. Scan this code  3. Enjoy your beer!'",
        "Countdown timer showing time remaining to redeem (calculated from order.expires_at)",
        "Timer updates every second, shows MM:SS format",
        "Order summary: beer name, quantity, venue name",
        "Screen brightness auto-maximized using expo-brightness",
        "Screen stays awake using expo-keep-awake",
        "'View Order Details' expandable/collapsible section with full info",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 10,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-006",
        "US-020"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-022",
      "title": "Build Real-Time Order Status Updates with animations",
      "description": "As a user, I want to see live status updates on my order so I know what's happening.",
      "acceptanceCriteria": [
        "On redeem screen (US-021): subscribe to order status changes via Supabase realtime",
        "Visual status stepper/progress bar: Paid -> Ready -> Scanned -> Pouring -> Complete",
        "Each step highlights as order progresses through states",
        "When status changes to 'pouring': transition screen to animated pouring state (Lottie beer pour animation)",
        "When status changes to 'completed': celebration animation, 'Enjoy your beer!' message",
        "When status changes to 'expired': show expiration message with 'You have not been charged' confirmation",
        "Each status change triggers subtle haptic feedback (expo-haptics)",
        "'Done' button on completed state returns to venue beer menu",
        "Unsubscribe from realtime when leaving the screen (cleanup)",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 11,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-021"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-023",
      "title": "Build Order History list screen",
      "description": "As a user, I want to view my past orders to see purchase history.",
      "acceptanceCriteria": [
        "Create app/(main)/orders/index.tsx with order history list",
        "Add 'Orders' tab in bottom tab navigation",
        "Chronologically sorted (newest first) using TanStack Query with pagination",
        "Each order card: beer name, venue name, date/time, quantity, total, status badge",
        "Status badges color-coded: green=completed, yellow=active, red=expired/cancelled, blue=refunded",
        "Tapping an order navigates to order detail screen",
        "Infinite scroll or 'Load more' pagination",
        "Empty state for new users: 'Your order history will appear here after your first pour!'",
        "Pull-to-refresh to reload",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 6,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-005",
        "US-014"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-024",
      "title": "Build Order Detail view with timeline",
      "description": "As a user, I want to see full details of a past order including its status timeline.",
      "acceptanceCriteria": [
        "Create app/(main)/orders/[id].tsx with full order detail",
        "Display: beer name, style, venue, tap #, quantity, pour size, unit price, total",
        "Order timeline showing all status transitions with timestamps (from order_events)",
        "Payment info: last 4 digits of card or 'Apple Pay'/'Google Pay'",
        "Stripe receipt link if available (opens in browser)",
        "'Reorder' button if same beer is still available at same venue (checks tap availability via API)",
        "For active orders (status = ready_to_redeem): show QR code and countdown, navigate to redeem screen",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 7,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-023"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-025",
      "title": "Build Profile screen with account management",
      "description": "As a user, I want to manage my account settings from a profile screen.",
      "acceptanceCriteria": [
        "Create app/(main)/profile/index.tsx",
        "Add 'Profile' tab in bottom tab navigation",
        "Display: full name, email, verification status badge (green 'Verified' or yellow 'Unverified')",
        "'Edit Profile' option: change name (email change requires confirmation)",
        "'Age Verification' section: show status, option to re-verify if needed",
        "'Payment Methods' link navigates to payment methods screen",
        "'Order History' link navigates to order history",
        "'Sign Out' button with confirmation dialog, calls Supabase auth.signOut(), clears secure store, navigates to welcome",
        "'Delete Account' option: requires re-authentication, then deletes via Supabase",
        "App version number displayed at bottom",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 6,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-014"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-026",
      "title": "Build Saved Payment Methods management",
      "description": "As a user, I want to manage my saved payment methods so checkout is fast.",
      "acceptanceCriteria": [
        "Create app/(main)/profile/payment-methods.tsx",
        "Fetch saved payment methods from Stripe via Edge Function (list customer payment methods)",
        "Display list: card brand icon, last 4 digits, expiry date",
        "Default payment method marked with indicator badge",
        "Swipe-to-delete gesture or explicit delete button with confirmation dialog",
        "Delete calls Stripe detach payment method API via Edge Function",
        "'Add Payment Method' button opens Stripe CardField for new card entry",
        "Set as default option on each card (calls Stripe update customer default)",
        "Empty state: 'No saved payment methods. Add one for faster checkout.'",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 7,
      "passes": false,
      "notes": "",
      "dependsOn": [
        "US-007",
        "US-025"
      ]
    },
    {
      "id": "US-027",
      "title": "Build Low Inventory handling UI states",
      "description": "As a user, I want clear messaging when beer is running low so I understand ordering limitations.",
      "acceptanceCriteria": [
        "In beer list (US-017): 'Low' badge already shown -- ensure it blocks the 'Continue' button on order config screen too",
        "On order config screen: if beer is 'Low', show message 'Limited stock -- order directly at the station' and disable CTA",
        "Backend enforces block (US-005 validation), but UI should also prevent navigation to payment",
        "If inventory drops below threshold during ANY step of order flow: show modal alert 'This beer is no longer available for mobile ordering', navigate back to beer list",
        "'Out' beers (0 remaining): fully disabled, greyed out, 'Sold Out' badge on beer list",
        "Inventory updates trigger via Supabase realtime subscription (already set up in US-017)",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 8,
      "passes": false,
      "notes": "",
      "dependsOn": [
        "US-017"
      ]
    },
    {
      "id": "US-028",
      "title": "Build Offline and Error state handling across the app",
      "description": "As a user, I want graceful error handling so the app never feels broken.",
      "acceptanceCriteria": [
        "Create components/OfflineBanner.tsx: detects network status using @react-native-community/netinfo",
        "Show persistent banner at top when offline: 'You're offline -- some features may be unavailable'",
        "All API calls use TanStack Query with retry logic (exponential backoff, max 3 retries)",
        "API errors show user-friendly messages (never raw error codes or stack traces)",
        "Create components/SkeletonLoader.tsx: reusable skeleton placeholder for loading states",
        "All screens use skeleton screens during loading (not blank screens or generic spinners)",
        "Payment screen: if network drops mid-payment, show 'Checking payment status...' and poll order status every 3s",
        "QR screen: works offline since QR is rendered client-side from stored token",
        "Session expired: detect 401 responses, auto-redirect to login with 'Please sign in again'",
        "Create lib/utils/error-handler.ts with centralized error formatting",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 8,
      "passes": false,
      "notes": "",
      "dependsOn": [
        "US-014"
      ]
    },
    {
      "id": "US-029",
      "title": "Build Redemption Timeout UI with Push Notifications",
      "description": "As a user with an active order, I want countdown warnings and push notifications so I don't miss my redemption window.",
      "acceptanceCriteria": [
        "Configure expo-notifications: request permission, register for push tokens",
        "Store push token in user profile (add push_token column to users table if needed)",
        "On QR screen: countdown timer already exists (US-021) -- ensure it turns yellow at 5min, red at 1min",
        "Schedule local notification at 5 minutes remaining: 'Your beer is waiting! Redeem soon.'",
        "Schedule local notification at 1 minute remaining: 'Last chance! Your order expires in 60 seconds.'",
        "Cancel scheduled notifications if order is redeemed before expiration",
        "When order expires: show full-screen 'Order Expired' message with 'You have not been charged' text",
        "Expired screen has 'Order Again' button to return to beer list",
        "Notification tapping opens the app to the active order's QR screen",
        "npx expo lint passes",
        "npx tsc --noEmit passes",
        "Visual verification on iOS simulator and Android emulator"
      ],
      "priority": 11,
      "passes": false,
      "notes": "",
      "dependsOn": [
        "US-010",
        "US-021"
      ]
    }
  ],
  "metadata": {
    "updatedAt": "2026-02-12T02:12:18.661Z"
  }
}